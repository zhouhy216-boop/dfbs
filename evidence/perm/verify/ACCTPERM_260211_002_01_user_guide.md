# ACCTPERM Step-002-01 — 账号列表与详情编辑 证据与用户验证指南

**Parent:** ACCTPERM-260211-002-01  
**Audience:** CEO / 初学者  
**Purpose:** 说明 Step-002-01 交付内容：主入口「系统 → 账号与权限」（Account & Permission Management）；**账号列表**展示用户名、岗位、部门、状态、角色；点击账号打开**详情抽屉**，可编辑启用/停用、重置密码、分配角色模板、管理覆盖权限；明确**角色模板与账号覆盖的合并规则**；入口与接口均为 admin/super-admin 可见。本文档支持通过 UI 与少量接口信息完成验证。

---

## 一、前置条件

- **权限**：仅 **admin 或 super-admin** 可访问「系统 → 账号与权限」入口及本步涉及的接口；非 admin 访问会 403。
- **默认密码**：账号创建或重置密码（未填新密码）时使用配置项 `dfbs.auth.defaultPassword`（如开发环境默认 `changeme`）；生产需在配置中显式设置。
- **入口**：系统菜单 **「系统」→「账号与权限」**，页面标题「账号与权限」；路由 `/admin/account-permissions`。该入口与 ACCTPERM-001 的「账号」「角色模板」「权限树」三个 Tab 一致，本步主要增强**账号 Tab** 的列表与详情编辑体验。

---

## 二、角色模板与账号覆盖的合并规则（无歧义）

- **角色模板**：为账号**分配**一个角色模板后，该账号**继承**该模板下的全部权限键（templateKeys）。
- **账号覆盖（overrides）**：在继承基础上，可为该账号**追加权限**（addKeys）或**移除权限**（removeKeys）；**移除优先**：同一权限键若既在追加又在移除中，以移除为准。
- **最终生效**：`最终生效权限 = (角色模板权限 ∪ 追加权限) ∖ 移除权限`。  
  产品与文档统一表述为：**继承自模板 + 仅展示变更（追加/移除）+ 最终生效**；详情抽屉中通过「差异视图」与「最终生效」展示，避免与「仅改模板」混淆。

---

## 三、UI 验证清单（≤12 条）

1. **入口与门控**：以 admin 或 super-admin 登录后，左侧菜单「系统」下可见「账号与权限」；点击进入后可见「账号」「角色模板」「权限树」（权限树 Tab 仅 allowlist 可见）；非 admin 直接访问 `/admin/account-permissions` 应被重定向或 403。
2. **账号列表与搜索**：在「账号」Tab 中，具备搜索框与账号列表（表格或列表）；支持按用户名/昵称搜索；若前端已接入 `GET /account-list`，列表列应包含：**用户名、岗位、部门、状态、角色**（角色为当前分配的角色模板名称）；否则可能仅显示 id、用户名、昵称、状态，岗位/部门在详情中展示。
3. **打开详情抽屉**：点击列表中某一行或「详情」按钮，打开**账号详情抽屉**；抽屉标题含该账号用户名或标识。
4. **详情内展示字段**：抽屉内应展示：用户名、昵称、ID、状态（启用/停用）、角色（当前角色模板名称）、岗位、部门（若后端无数据则显示「—」）。
5. **启用/停用**：在详情抽屉中可通过开关**启用/停用**账号；停用后该账号登录应得到 403（或 401），验证禁用登录生效。
6. **重置密码**：详情内提供「重置密码」按钮；弹窗中可选**留空**（重置为默认密码）或**填写新密码**；提交后再次登录需使用新密码或默认密码。
7. **分配角色模板**：在详情抽屉中可**选择角色模板**（下拉，默认仅启用模板）；保存后该账号继承新模板的权限；与下方「追加/移除」一起构成完整覆盖。
8. **差异视图与覆盖**：权限区默认以**差异视图**展示：继承自模板（只读摘要）、**追加权限**、**移除权限**、**最终生效**（数量 + 可展开列表）；「添加权限」「移除权限」通过选择器操作；**移除优先**：同一键既追加又移除时以移除为准。
9. **最终生效可见**：有「最终生效」摘要（数量）及「展开查看全部有效权限」；展开后列表与当前草稿的「(模板 ∪ 追加) ∖ 移除」一致，并标明「保存后生效」。
10. **保存与还原**：修改模板、追加或移除后，需点击「保存」才写入后端；「还原」恢复上次保存状态；未保存即切换账号或刷新，变更不生效。
11. **allowlist 与 非 allowlist**：**allowlist（可访问权限树）**：可加载权限树，详情中可见「添加权限」「移除权限」、高级编辑（模块卡片与菜单树）。**非 allowlist 管理员**：仍可进入账号 Tab、查看列表与详情、启用/停用、重置密码、分配角色模板；权限区仅展示差异视图与最终生效，**不显示**「添加权限」「移除权限」及权限树，并提示无权限查看权限树。
12. **列表与详情数据一致**：列表中的状态、角色与详情抽屉内一致；详情中修改并保存后，列表刷新应反映最新状态与角色。

---

## 四、后端参考（最小）

- **账号列表（admin-only）**：`GET /api/v1/admin/account-permissions/account-list?query=&limit=`  
  - 参数：`query` 可选，空则返回前 N 条；`limit` 可选，默认 50，范围 1–200。  
  - 响应每行含：userId, username, nickname, enabled, orgPersonId, position, department, roleTemplateId, roleTemplateLabel。  
  - 门控：AdminOrSuperAdminGuard；非 admin 返回 403。  
- 账号详情、覆盖、启用/停用、重置密码、角色模板等仍使用既有接口（如 `GET/PUT .../accounts/{userId}/override`、`PUT .../accounts/{userId}/enabled`、`POST .../accounts/{userId}/reset-password` 等），未变更。

---

## 五、回归说明

- **ACCTPERM-001 入口**：「系统 → 账号与权限」下的「账号」「角色模板」「权限树」三个 Tab 及原有能力（角色模板 CRUD、权限树 allowlist、账号覆盖保存/还原）均保持可用；本步仅增强账号列表与详情抽屉，不替代原有入口逻辑。
- **RBAC 与门控**：平台/工单等模块的 RBAC 校验、effective-keys、allowlist 仅控制权限树等逻辑不变；本步不扩大或缩小权限树暴露范围。

---

## 六、常见注意点

- 若前端尚未接入 `account-list`，列表可能仍为原搜索接口（仅 id/用户名/昵称/状态），岗位、部门、角色可能在详情抽屉中通过其他接口或占位「—」展示；接入 `account-list` 后列表即可展示岗位、部门、角色。
- 禁用账号登录 403 的验证需在登录接口与前端登出后使用该账号重新登录确认。
- 与 Step-05 一致：有效权限 = (模板 ∪ 追加) ∖ 移除；向业务方说明时强调「先模板、再追加、再按移除做减法」，避免与「只改模板」混淆。

---

## 七、CEO 一句话验证要点

1. **入口与列表**：在「系统 → 账号与权限」→ 账号 Tab 中，能看到账号列表（含用户名、岗位、部门、状态、角色等，视前端是否已接 account-list）；可通过搜索筛选账号。
2. **详情与编辑**：点击某账号打开详情抽屉，可进行启用/停用、重置密码、分配角色模板、以及差异视图下的追加/移除权限；最终生效区可展开查看，保存后生效；角色模板与覆盖的合并规则为「(模板 ∪ 追加) ∖ 移除」。
3. **门控与回归**：仅 admin/super-admin 可见该入口与接口；原有「账号与权限」三个 Tab 及 RBAC 行为未受影响。

---

**Build/test status:** 文档仅作证据与验证说明；构建/测试可标为「未执行」或以当前仓库后端 `.\mvnw.cmd -q -DskipTests compile` 及前端 `npm run build` 结果为准。
