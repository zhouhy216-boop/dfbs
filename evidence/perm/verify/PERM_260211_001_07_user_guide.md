# Step-07 工单权限 — 证据与用户验证指南

**Parent:** PERM-260211-001-07  
**Audience:** CEO / 初学者  
**Purpose:** 说明 Step-07 交付内容：工单模块的**前端隐藏**（菜单/页面/按钮）与**后端 403 鉴权**；使用与平台管理相同的 RBAC 模型（模板 + 追加 - 移除，移除优先）；公开工单创建流程**未改动**（v1 排除）。

---

## 一、映射与范围

- **权限映射（唯一依据）：** `docs/perm-work-order-mapping-v1.md`  
  - 菜单/路由、按钮、后端接口与权限 key 的对应关系均以该文档为准。
- **公开接口（v1 排除）：** `POST /api/v1/public/work-orders/create` 未加权限校验，保持原样；是否在后续迭代中加权限为 **TBD**。

---

## 二、前置条件

- **测试账号**：使用测试账号套件（如 `perm_t2_view` 仅 VIEW、`perm_t3_org_editor` 等）可快速验证“无权限时菜单/按钮隐藏、有权限时按钮出现”。
- **Role-Vision（可选，仅测试环境）：** 在「角色与权限」页使用 Role-Vision「按用户」可快速切换视角，验证不同权限下的菜单与按钮展示；**后端鉴权始终按当前登录用户**，不受 vision 影响。
- **RBAC 模型**：与 Step-05 一致，有效权限 = (角色模板 ∪ 账号追加) \ 账号移除，移除优先；前端 `useEffectivePermissions()` 与后端 `PermEnforcementService` 使用同一套 key。

---

## 三、UI 验证清单（≤12 条）

1. **无 work_order:VIEW**：侧栏「售后服务」下**不显示**「工单管理」入口。
2. **无 work_order:VIEW 直接访问**：浏览器打开 `/work-orders` 或 `/work-orders/:id` → 先显示「加载中...」，再**重定向到 /dashboard**。
3. **仅有 work_order:VIEW**：能进入工单列表与详情页，可看到待受理池/待派单池/我的工单/全部工单及详情只读内容；**不显示**「新建工单」「受理」「驳回」「派单」「接单」「添加记录」「添加配件」「消耗配件」「提交签字」「完修」等操作按钮。
4. **增加 work_order:CREATE**：工单列表页出现「新建工单」按钮。
5. **增加 work_order:ASSIGN**：列表/详情页出现「受理」「派单」按钮（在状态允许时）。
6. **增加 work_order:REJECT**：待受理/全部池中出现「驳回」操作。
7. **增加 work_order:SUBMIT**：详情页在已派单且当前用户为服务负责人时出现「接单」按钮。
8. **增加 work_order:EDIT**：详情页出现「开始处理」「添加记录」「添加配件」及配件表中的「消耗配件」。
9. **增加 work_order:APPROVE**：详情页在流程中出现「提交签字」按钮。
10. **增加 work_order:CLOSE**：详情页在待签字时出现「完修」按钮。
11. **后端鉴权**：用仅有 VIEW 的账号（或通过 Role-Vision 切到仅 VIEW 用户）在浏览器 Network 中直接触发或通过脚本调用任一带权限的写接口（如 `POST /api/v1/work-orders/create`、`/dispatch`、`/complete` 等）→ 应返回 **403**，响应体中 **machineCode=PERM_FORBIDDEN**（与 Step-05 一致）。
12. **刷新/登出/再登录**：无权限泄漏；平台管理、申请管理、角色与权限等 Step-05/06 页面与行为不变；公开工单创建（如 `/public/repair` 提交）流程未被本步改动。

---

## 四、CEO 一句话验证要点

1. **无 VIEW 则不可见**：没有 `work_order:VIEW` 时看不到「工单管理」菜单，直接访问工单 URL 会被重定向到首页。
2. **有 VIEW 无操作权则只读**：仅有 VIEW 时只能看列表与详情，所有操作按钮隐藏；后端对写接口返回 403 PERM_FORBIDDEN。
3. **与现有 RBAC 一致**：工单权限与平台管理使用同一套模板/追加/移除逻辑；公开工单创建接口未纳入本步，行为不变。
