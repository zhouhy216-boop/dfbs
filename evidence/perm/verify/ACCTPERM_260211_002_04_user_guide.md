# ACCTPERM Step-002-04 — 权限管理与账号覆盖 证据与用户验证指南

**Parent:** ACCTPERM-260211-002-04  
**Audience:** CEO / 初学者  
**Purpose:** 说明 Step-002-04 交付内容：**权限管理** Tab（allowlist-only）可管理全部模块（编辑/删除/设置动作）、启用/停用模块可见性（v1 仅影响可见性）；**按账号覆盖**保持差异视图、追加/移除、移除优先、保存后生效与还原；入口为 admin-only，权限管理 Tab 仅 allowlist 可见。本文档支持通过 UI 完成验证。

---

## 一、前置条件

- **入口**：系统菜单 **「系统」→「账号与权限」**；仅 **admin 或 super-admin** 可进入该页面。
- **权限管理 Tab 可见性**：**allowlist**（Perm super-admin allowlist）用户可见第三个 Tab「**权限管理**」，并可调用模块管理接口（GET permission-tree、POST/PUT/DELETE /modules、PUT /modules/{id}/actions）。**非 allowlist** 管理员仅见「账号」「角色模板」两个 Tab，不见「权限管理」，无法管理模块与权限树。
- **账号覆盖**：在「账号」Tab 中选中账号后，在详情抽屉内可管理该账号的继承模板与覆盖（追加/移除）；allowlist 用户可使用高级编辑与选择器，非 allowlist 仅能查看差异与最终生效、无法通过选择器增删覆盖项。

---

## 二、UI 验证清单（≤12 条）

1. **Tab 名称「权限管理」**：以 allowlist 账号进入「账号与权限」后，第三个 Tab 标签为「**权限管理**」（非「权限树」）。
2. **模块列表包含全部模块**：在权限管理 Tab 内，「模块列表（可编辑全部）」表格展示**所有**模块（既有 + 新建），每行有 ID、key、显示名称、父节点 ID、状态、操作。
3. **启用/停用与「已停用」标签**：表格「状态」列显示「已启用」或「已停用」Tag，以及启用/停用 **Switch**；停用模块在树上同样显示「已停用」Tag。
4. **Tooltip 与说明**：悬停状态列 Switch 时，Tooltip 提示「停用仅影响可见性（v1），不删除数据」；表格上方有相同文案说明。
5. **编辑模块**：点击某行「编辑」后，可修改**显示名称**、**父节点**（下拉为除自身外的其他模块或根节点）、**启用** Switch；保存后列表与树刷新；父节点不能选自身（下拉已排除自身）；若选无效父节点（如子节点导致环），保存时后端报错，前端展示错误信息。
6. **无效父节点错误**：编辑区说明「不能将父级设为自己或子节点；无效选择时保存会提示错误。」；实际保存失败时出现友好错误提示（如「不能将父级设为自己」或后端返回的校验信息）。
7. **设置动作**：点击某行「设置动作」后，在弹窗中勾选该模块可用的动作，保存后立即生效；列表与树中该模块的 actions 更新。
8. **删除模块**：点击「删除」可删除该模块；若该模块下有子模块，后端返回错误（如「该模块下有子模块，请先删除子模块」），前端展示该提示。
9. **新建模块**：可输入模块 key、显示名称、父节点、启用状态后创建；创建后列表与树自动刷新，新模块出现在列表中且可编辑/删除/设置动作。
10. **账号覆盖差异视图（交叉核对）**：在「账号」Tab 选中某账号并打开详情抽屉，权限区为**差异视图**：继承自模板、追加权限、移除权限、最终生效；**移除优先**：同一键既追加又移除时以移除为准。
11. **保存与还原**：账号覆盖修改后需点击「保存」才写入；「还原」恢复上次保存状态；权限管理 Tab 内模块的编辑/设置动作/删除均立即请求后端，无草稿。
12. **门控**：非 admin 无法进入「账号与权限」页面；非 allowlist 管理员不显示「权限管理」Tab，仅能使用账号与角色模板能力。

---

## 三、说明与约束

- **停用含义**：**停用仅影响可见性（v1），不删除数据**；模块数据与动作配置保留，仅用于控制是否在界面/树中展示或参与可见性逻辑（v1 不改变运行时菜单鉴权逻辑）。
- **后端接口**：本步无新增后端 API；沿用现有 `/api/v1/admin/perm/permission-tree`、`/api/v1/admin/perm/modules`（POST/PUT/DELETE）、`/api/v1/admin/perm/modules/{id}/actions`（allowlist 门控），以及 `/api/v1/admin/account-permissions/accounts/{userId}/override`（GET/PUT）等账号覆盖接口。

---

## 四、CEO 一句话验证要点

1. **权限管理**：在「账号与权限」→「权限管理」Tab 中，可管理**全部**模块（编辑名称/父节点/启用、设置动作、删除）；启用/停用通过 Switch 切换，停用模块显示「已停用」；文案明确「停用仅影响可见性（v1），不删除数据」。
2. **账号覆盖**：在账号详情抽屉中，权限为差异视图（继承/追加/移除/最终生效），移除优先；保存后生效、还原恢复上次状态。
3. **门控**：仅 admin/super-admin 可进入该入口；仅 allowlist 可见「权限管理」Tab 并操作模块与权限树。

---

**Build/test status:** 文档仅作证据与验证说明；构建/测试可标为「未执行」或以当前仓库后端编译及前端构建结果为准。
