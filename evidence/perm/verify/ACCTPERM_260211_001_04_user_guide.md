# ACCTPERM Step-04 — 权限编辑 UX（模块概览 + 菜单树 + 更多动作）证据与用户验证指南

**Parent:** ACCTPERM-260211-001-04  
**Audience:** CEO / 初学者  
**Purpose:** 说明 Step-04 交付内容：**模块概览卡片**（全选/只读/读写/清空）、**菜单树复选框**（勾选=至少 VIEW 含子树，取消=清空该菜单下全部动作含子树）、**更多动作默认折叠**、**保存后生效 + 还原**；在**角色模板**与**账号覆盖**两处均可用；非 allowlist 管理员见「无权限查看权限树」且保存**不清空权限键**。本文档支持**仅通过 UI** 完成验证。

---

## 一、核心 UX 承诺

- **模块概览卡片**：在权限编辑区域上方，按根级模块展示卡片；每张卡片有快捷操作：**只读**、**读写**、**全选**、**清空**；点击后仅更新**当前草稿**，需点「保存」后才生效。
- **菜单树复选框**：每个模块节点一行，左侧有**菜单级复选框**。**勾选**：该节点及整棵子树至少授予「查看」（VIEW）；**取消勾选**：该节点及子树下**全部动作**从草稿中移除。
- **基础动作常显 + 更多动作折叠**：每节点下 **VIEW / CREATE / EDIT**（若该模块存在）常显；其余动作（如 SUBMIT、APPROVE、REJECT、ASSIGN、CLOSE、DELETE、EXPORT）收在 **「更多动作」** 折叠区内，**默认折叠**，展开后可细粒度勾选。
- **保存后生效、还原恢复**：任意修改（卡片快捷操作、菜单勾选、动作勾选/三态）均为**草稿**；点击 **「保存」** 才写入后端；**「还原」** 恢复为上次保存的状态。
- **两处入口一致**：「系统 → 账号与权限」→ **角色模板** Tab 与 **账号** Tab 的权限编辑区均采用上述交互；账号 Tab 下为**三态**（默认/添加/移除，移除优先）。

---

## 二、前置条件

- **入口**：
  - **角色模板**：「系统 → 账号与权限」→ **角色模板** Tab，选中一个角色后，右侧为权限编辑区（模块概览 + 菜单树）。
  - **账号覆盖**：「系统 → 账号与权限」→ **账号** Tab，选中一个账号后，下方为权限编辑区（同上）。
- **allowlist 与 非 allowlist**：
  - **allowlist（权限树超级管理员）**：可加载权限树，看到模块概览卡片与菜单树，可进行快捷操作与勾选。
  - **非 allowlist 管理员**：进入上述 Tab 后，若接口返回 403，会显示 **「无权限查看权限树（需超级管理员）」**；**不渲染**模块概览卡片与菜单树；仍可改角色名称/启用/描述（角色模板）或切换模板（账号）；保存时**不会清空**该角色/账号已有权限键（前端会提交当前已保存的 permissionKeys/add/remove）。

---

## 三、UI 验证清单（≤12 条）

1. **模块概览卡片存在**：在角色模板或账号 Tab 的权限编辑区**上方**，可见多张模块卡片（标题为模块名称），每张卡片有「只读」「读写」「全选」「清空」按钮；可选显示「已选 X / 总数 Y」。
2. **卡片快捷操作仅改草稿**：点击某模块卡片的「只读」/「读写」/「全选」/「清空」后，下方菜单树与动作勾选立即变化，但**未点「保存」前**不请求后端；点「保存」后变更生效；点「还原」可恢复点击快捷操作前的状态。
3. **菜单复选框 — 勾选 = 至少 VIEW**：在菜单树中勾选某模块节点的复选框，该节点及其**整棵子树**应至少获得「查看」（VIEW）；若该节点有 VIEW 动作，则 VIEW 被勾选；子节点同理。
4. **菜单复选框 — 取消 = 清空子树**：取消勾选某模块节点的复选框，该节点及其**整棵子树**下的**全部动作**从草稿中移除（角色模板下为取消勾选，账号覆盖下为从有效权限中移除）。
5. **基础动作常显**：每个模块节点下，**VIEW、CREATE、EDIT**（若该模块的 actions 中存在）直接展示为复选框（角色模板）或三态选择（账号 Tab），无需展开即可操作。
6. **更多动作默认折叠**：除 VIEW/CREATE/EDIT 外的动作（如 SUBMIT、APPROVE、REJECT、ASSIGN、CLOSE、DELETE、EXPORT）位于 **「更多动作」** 折叠区内；**默认折叠**，点击「更多动作」展开后可进行勾选或三态选择。
7. **账号覆盖三态与移除优先**：在账号 Tab 下，每个动作为 **默认（继承模板）/ 添加 / 移除**；「移除」优先于模板与添加，即有效权限 = (模板 ∪ 添加) \ 移除；菜单勾选/取消与卡片快捷操作均通过 add/remove 草稿实现，与上述规则一致。
8. **保存与还原**：修改任意权限草稿（卡片、菜单勾选、动作）后，「保存」可点；点击后请求后端并提示成功；「还原」恢复为上次保存的权限状态；未点保存时切换至其他角色/账号，再切回，草稿仍为未保存状态（或按产品实际行为）。
9. **刷新/切换对象**：在未保存情况下刷新页面或切换至其他角色/账号，草稿变更**不生效**（需先点「保存」）；保存后，切换对象再切回，应看到已持久化的权限。
10. **非 allowlist 无卡片与树**：使用非 allowlist 的 Admin 账号进入角色模板或账号 Tab，若后端返回 403，应显示「无权限查看权限树（需超级管理员）」；**不渲染**模块概览卡片与菜单树；仍可修改角色名称/启用/描述或账号侧模板等；保存时**不会清空**该角色/账号已有权限（前端提交已保存的 permissionKeys 或 override）。
11. **读写 v1 保守**：「读写」快捷操作仅设置 **VIEW + CREATE + EDIT**；高级动作（SUBMIT、APPROVE 等）不默认勾选，需用户在「更多动作」中手动勾选。
12. **与 04.b 模块卡片一致**：模块概览卡片与 04.b 实现一致；菜单树与卡片的草稿为同一份，卡片「只读/读写/全选/清空」与树中勾选、动作勾选应一致；保存/还原对两者同时生效。

---

## 四、说明与约束

- **「读写」映射 v1 保守**：仅包含 VIEW、CREATE、EDIT；高级动作不默认全选，避免过度授权。
- **不涉及字段级权限与复杂条件规则**：本步仅包含模块级 + 动作级勾选/三态，无字段级或条件规则配置。

---

## 五、回归说明

- **Step-04.b 模块概览卡片**：与 Step-04.c 菜单树共用同一草稿；卡片快捷操作与菜单树勾选、动作勾选一致，保存/还原对整份草稿生效。
- **非 allowlist 保存不清空**：无权限查看权限树时，保存名称/启用/描述或模板时，不会清空该角色/账号已有权限键。
- **平台/工单 RBAC**：本步仅改权限编辑 UI（账号与权限 → 角色模板 / 账号），不影响平台管理、工单、effective-keys 等既有鉴权与菜单/按钮隐藏。

---

## 六、常见注意点

- **前端构建报错**：若 `npm run build` 因**其他文件**的 TypeScript 报错失败，与 Step-04 的权限编辑验证**无冲突**；可在浏览器中进入「账号与权限」→ 角色模板 / 账号 Tab，按上述清单逐条验证。
- **菜单勾选与子树**：勾选某节点即对该节点**及整棵子树**应用「至少 VIEW」；取消勾选即对该节点**及整棵子树**清空全部动作，与 04.b 的「只读」「清空」语义一致。

---

## 七、CEO 一句话验证要点

1. **模块卡片 + 菜单树**：在「账号与权限」→ 角色模板或账号 Tab 中，能看到**模块概览卡片**（只读/读写/全选/清空）和**菜单树**（每行有菜单复选框 + 基础动作 + 「更多动作」折叠）；勾选菜单=至少 VIEW 含子树，取消=清空该菜单下全部动作含子树。
2. **保存/还原与两处一致**：所有改动均为草稿，点「保存」生效、点「还原」恢复；行为在角色模板与账号覆盖两处一致；账号 Tab 下为三态（默认/添加/移除，移除优先）。
3. **非 allowlist 不渲染树且不清空**：无权限查看权限树时，只显示提示，不展示卡片与树；保存时不会清空该角色/账号已有权限。

---

**Build/test status:** 文档仅作证据与验证说明；若需执行构建/测试，以当前仓库 `npm run build` 及后端编译结果为准（可为“未执行”）。
