# ACCTPERM Step-02 — 内部员工账号管理 v1 证据与用户验证指南

**Parent:** ACCTPERM-260211-001-02  
**Audience:** CEO / 初学者  
**Purpose:** 说明 Step-02 交付内容：**通过绑定已有组织人员创建账号**（无自由创建人员）、**一人一号**唯一性、**用户名全局唯一**、**默认密码可配置**（无强制首次登录改密）、管理员操作：**启用/停用**、**重置密码**、**分配角色模板**；停用账号登录返回 403。本文档支持**仅通过 UI** 完成验证。

---

## 一、前置条件

- **默认密码（dev）：**
  - 配置项 **dfbs.auth.defaultPassword**（如 `application.yml` 或 profile 中），开发环境默认值为 **changeme**。
  - 新创建账号的初始密码为该值；重置密码时若**不填新密码**则恢复为该默认密码。
  - 生产环境需显式设置，不得使用 dev 默认值。
- **谁可访问（与 Step-01 一致）：**
  - **Admin / Super-admin**：`userInfo.roles` 含 **ADMIN** 或 **SUPER_ADMIN** 的用户可进入「系统 → 账号与权限」并使用**账号** Tab（含创建账号、启用/停用、重置密码、分配角色模板）。
  - **Allowlist**：仅影响「权限树」Tab 的可见性及权限树/模块接口；**不影响**账号创建、启用/停用、重置密码、分配角色模板等 Step-02 功能。
- **组织人员数据：**
  - 「创建账号（绑定人员）」依赖**已有**组织人员（Org Person）；人员管理接口仍为 **SuperAdmin 专用**，未放开；Step-02 仅提供 **Admin 专用** 的**人员选项接口** `GET /api/v1/admin/account-permissions/people?query=...` 用于绑定选人，不弱化现有 `/api/v1/org-structure/*` 的 SuperAdmin 门控。

---

## 二、UI 验证清单（≤12 条）

1. **创建账号入口**：在「账号与权限」→ **账号** Tab 中，搜索账号区域旁有按钮 **「创建账号（绑定人员）」**，点击后弹出创建账号弹窗。
2. **创建账号 — 选择人员**：弹窗内「选择人员」为可搜索下拉框，输入关键词会调用人员选项接口，列表展示**姓名 · 组织 · 职位**（如有）；选择一名**未绑定账号**的在职人员。
3. **创建账号 — 必填与选填**：**用户名**为必填（登录用），**昵称**与**角色模板**为选填；提交后应提示「账号已创建」，并自动选中新账号，右侧展示其覆盖信息。
4. **错误：人员已绑定**：若所选人员已绑定过账号，提交后应提示 **「该人员已绑定账号，无法重复创建」**（对应 400 machineCode：ACCTPERM_PERSON_ALREADY_BOUND）。
5. **错误：用户名已存在**：若输入的用户名与已有账号重复，提交后应提示 **「用户名已存在」**（对应 ACCTPERM_USERNAME_EXISTS）。
6. **错误：人员不存在或已停用**：若人员不存在或已停用，提交后应提示相应错误（ACCTPERM_PERSON_NOT_FOUND / ACCTPERM_PERSON_NOT_ACTIVE）。
7. **启用/停用**：选中某账号后，详情区有 **「启用」** 开关；关闭后应调用接口并提示「已停用」，再次打开提示「已启用」；界面刷新后开关状态与后端一致。
8. **停用账号登录 => 403**：将某账号**停用**后，使用该账号登录（用户名 + 正确密码）应返回 **403**，提示「Account disabled」；启用后即可正常登录（验证 02.b 鉴权）。
9. **重置密码 — 留空为默认**：选中账号后点击 **「重置密码」**，弹窗中**不填**新密码直接确定，应提示「已重置为默认密码」；使用 **dfbs.auth.defaultPassword**（如 changeme）可登录该账号。
10. **重置密码 — 自定义密码**：在重置密码弹窗中输入新密码并确定，应提示「密码已重置」；使用该新密码可登录，旧密码不可用。
11. **分配角色模板**：选中账号后，在右侧「分配角色模板」下拉框选择模板（可选「显示全部（含停用）」），配合添加/移除覆盖后点击 **「保存」**，行为与 Step-01 一致；创建账号时也可在弹窗中选填角色模板，创建即生效。
12. **回归**：平台管理、工单、effective-keys、角色与权限等既有 RBAC 流程与接口行为**未改动**；仅新增账号创建、启用/停用、重置密码的 UI 与对应 account-permissions 接口。

---

## 三、回归说明

- **现有 RBAC**：平台管理、工单、权限树、角色模板与账号覆盖的「移除优先」逻辑、effective-keys、菜单/按钮鉴权等均未因 Step-02 改变。
- **组织架构接口**：`/api/v1/org-structure/*` 仍为 **SuperAdmin 专用**；Step-02 仅提供 Admin 使用的 `GET /api/v1/admin/account-permissions/people?query=...` 用于创建账号时选人，不开放组织架构的增删改。

---

## 四、常见注意点

- **组织架构仍为 SuperAdmin**：人员的新增/编辑/停用等仍在「组织架构」相关页且需 SuperAdmin；Step-02 的「创建账号」只是在**已有人员**中选人绑定，不提供自由创建人员。
- **人员选项为 Admin 专用代理**：账号 Tab 内创建账号时的人员下拉数据来自 **account-permissions/people**，与 org-structure 的 SuperAdmin 接口分离；非 Admin 无法访问本页，故不会通过本入口绕过组织架构权限。
- **前端构建报错**：若 `npm run build` 因**其他文件**的 TypeScript 报错失败，与 Step-02 的账号创建/启用/停用/重置密码验证**无冲突**；可用 Admin 账号登录后按上述清单在浏览器中逐条验证。

---

## 五、CEO 一句话验证要点

1. **创建账号只能绑定已有人员**：在「账号与权限」→ 账号 Tab 点「创建账号（绑定人员）」→ 选人员、填用户名（必填）→ 成功即创建；同一人员不能重复绑定；用户名不能与已有账号重复。
2. **启用/停用与重置密码**：选中账号后可开关「启用」、点「重置密码」（留空=默认密码，填写=新密码）；停用后该账号登录会 403，启用后恢复正常。
3. **角色模板与既有 RBAC 不变**：分配角色模板仍通过右侧模板选择与添加/移除覆盖完成；平台、工单等现有权限逻辑未受影响。
