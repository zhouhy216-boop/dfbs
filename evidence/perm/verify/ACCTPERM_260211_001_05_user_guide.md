# ACCTPERM Step-05 — 账号覆盖 diff-only（差异视图）证据与用户验证指南

**Parent:** ACCTPERM-260211-001-05  
**Audience:** CEO / 初学者  
**Purpose:** 说明 Step-05 交付内容：账号覆盖**默认以差异视图展示**（继承 vs 仅展示变更：追加/移除）；**添加权限**与**移除权限**通过选择器操作，**移除优先**；**最终生效**数量 + 可展开列表（含搜索），并标明「保存后生效」；**无**按权限逐项三态下拉；保存/还原语义不变；非 allowlist 仅见只读差异视图、无选择器与树。本文档支持**仅通过 UI** 完成验证。

---

## 一、核心 UX 承诺

- **默认差异视图**：选中账号后，权限区**默认**展示四块：1）继承自模板（只读摘要：模板名称 + 继承数量）；2）追加权限（Add，仅列出 addKeys）；3）移除权限（Remove，仅列出 removeKeys，标明移除优先）；4）最终生效（数量 +「展开查看全部有效权限」）。
- **添加/移除通过选择器**：通过「添加权限」「移除权限」按钮打开选择器弹窗，勾选后确定写入草稿；**不**使用按权限的三态下拉；选择「添加」时若该键原在移除列表则自动从移除中剔除（移除优先仍成立）。
- **最终生效可见**：展示有效权限数量；点击「展开查看全部有效权限」打开抽屉，按模块分组、支持搜索，标题标明「保存后生效」。
- **高级编辑可选、默认折叠**：模块概览卡片与菜单树放入「高级编辑（可选）」折叠区，**默认折叠**，需要时展开使用。
- **保存后生效、还原恢复**：所有变更均为草稿；点「保存」才写后端；「还原」恢复上次保存状态。

---

## 二、前置条件

- **入口**：「系统 → 账号与权限」→ **账号** Tab；先搜索并选中一个账号，下方即为权限覆盖区（差异视图 + 可选高级编辑）。
- **allowlist 与 非 allowlist**：
  - **allowlist（可访问权限树）**：可加载权限树；差异视图中显示「添加权限」「移除权限」按钮，可打开选择器；可展开「高级编辑」使用模块卡片与菜单树。
  - **非 allowlist 管理员**：仍可进入账号 Tab 并选中账号；差异视图**可见**（继承摘要、追加列表、移除列表、最终生效数量及展开）；**不显示**「添加权限」「移除权限」按钮；不渲染选择器与权限树；会提示「无权限查看权限树」。继承数量等仍由现有接口（roles/{id}/permissions、override）推导，无需新接口。

---

## 三、UI 验证清单（≤12 条）

1. **默认出现差异视图四块**：选中账号后，权限区默认展示：1）继承自模板（只读）：当前模板名称 +（若已选模板）继承数量；2）追加权限（Add）：仅 addKeys，按模块分组；3）移除权限（Remove）：仅 removeKeys，按模块分组，有「移除优先」提示；4）最终生效：共 X 项 +「展开查看全部有效权限」。
2. **追加/移除仅展示变更项**：追加区只列 addKeys，移除区只列 removeKeys；不展示「未变更」的继承项列表，避免冗长。
3. **「添加权限」选择器**：点击「添加权限」打开弹窗，树形勾选要追加的权限，确定后这些键加入「追加权限」列表；若某键原先在「移除权限」中，确定后应从移除列表中消失（自动去重，移除优先语义不变）。
4. **「移除权限」选择器**：点击「移除权限」打开弹窗，勾选要从有效权限中移除的项，确定后加入「移除权限」列表，并从「追加权限」中剔除相同键。
5. **最终生效抽屉**：点击「展开查看全部有效权限」打开抽屉；标题含「保存后生效」或类似说明；列表按模块分组，支持搜索；内容与当前草稿计算的 effective（模板∪添加∖移除）一致。
6. **保存与还原**：修改追加/移除或模板后，「保存」可点；点击后请求成功、列表与后端一致；「还原」恢复为上次保存的 override 状态。
7. **刷新/切换账号**：未保存时刷新或切换账号，草稿变更不生效；保存后切换账号再切回，应看到已持久化的追加/移除与最终生效。
8. **高级编辑默认折叠**：「高级编辑（可选）」折叠区**默认折叠**；展开后可见模块概览卡片与菜单树（与 Step-04 一致），行为与差异视图草稿一致。
9. **非 allowlist 仅只读差异**：使用无权限树的 Admin 账号，差异视图仍可见（继承摘要、追加、移除、最终生效数量）；**不显示**「添加权限」「移除权限」按钮；无选择器、无权限树；提示无权限查看权限树。
10. **移除优先**：有效权限 = (继承 ∪ 追加) ∖ 移除；同一键若既在追加又在移除，以移除为准；选择器与高级编辑的变更均遵守该规则。
11. **无三态逐项下拉**：默认与差异视图中**不**使用「每个权限一列三态（默认/添加/移除）」下拉；仅通过「添加权限」「移除权限」选择器与（可选）高级编辑中的树/卡片操作。
12. **数据来源无新接口**：继承数量与列表由现有 GET override + GET roles/{id}/permissions + GET roles 推导；无需新增 override-diff 等只读接口。

---

## 四、说明与约束

- **移除优先**：effective = (template ∪ add) \ remove；产品与文档均保持一致表述。
- **无新后端只读接口**：Step-05.c 已确认，前端通过现有 GET override、GET account-permissions/roles/{id}/permissions、GET roles 即可完整呈现「继承 vs 覆盖 vs 最终生效」。

---

## 五、回归说明

- 保存/还原、PUT override 语义未改；平台/工单 RBAC、effective-keys 不受影响。
- 非 allowlist 仍无法使用选择器与权限树，但差异视图可读且保存不清空权限。

---

## 六、常见注意点

- 若前端构建因其他文件 TS 报错失败，与 Step-05 的 diff 验证无冲突；可在浏览器中登录 Admin，进入「账号与权限」→ 账号 Tab 按清单逐条验证。
- 选择器与高级编辑依赖权限树；无权限树时仅能查看差异与最终生效，不能通过 UI 增删覆盖项（需有权限树或后续产品约定方式）。

---

## 七、CEO 一句话验证要点

1. **默认差异视图**：在「账号与权限」→ 账号 Tab 选中账号后，默认看到四块：继承摘要、仅追加列表、仅移除列表、最终生效数量与可展开列表；添加/移除通过按钮打开选择器，无按权限三态下拉。
2. **最终生效与保存**：最终生效区标明数量并可展开查看全部（含搜索），且明确「保存后生效」；保存/还原行为与之前一致；高级编辑默认折叠。
3. **非 allowlist**：无权限树时仍可见差异视图与最终生效，但无「添加权限」「移除权限」按钮、无选择器与树；数据由现有接口推导，无新接口。

---

**Build/test status:** 文档仅作证据与验证说明；构建/测试可标为「未执行」或以当前仓库 `npm run build` 及后端编译结果为准。
