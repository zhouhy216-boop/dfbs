# THREAD：表单自定义轮子（表单+节点字段+按钮可配置 + 按钮动作引擎）
状态：进行中（目标：讨论清楚后直接做；本 THREAD 用于防止下次重复沟通）

## 0) 目的（给未来的我/你）
- 让发货/委托/工单/申请四类页面支持“管理员可配置表单”：增删改字段、调顺序、设校验、不同节点显示不同字段、不同节点不同按钮。
- 同时把“按钮怎么执行”统一收口：取消/保存草稿/清空/提交/通过/驳回/退回补充/撤回/关闭/转派等都走同一套动作引擎，后期加功能不需要每个表单单独改。
- 避免系统臃肿：能力做“足够通用的积木”，不做“无限复杂的万能规则”。

---

## 1) 已冻结（不再反复讨论）
### 1.1 覆盖范围
- 首批覆盖页面：发货 / 委托 / 工单 / 申请（含平台管理下多入口：服务申请/销售申请/替企申请/新建机构等）。

### 1.2 核心能力（管理员能做什么）
**表单结构**
- 支持字段：新增/删除/停用、改字段名、调整顺序、分组、折叠、两列/三列布局。
- 目标体验：字段很多时依旧清爽（常用区块默认展开，次要区块可折叠）。

**字段类型（第一版就要覆盖 A~J）**
- 单行文本、多行文本、数字、日期/时间、单选/下拉、多选、地址、附件、明细表（表格行）、关联选择（引用别的资料/对象）。

**校验规则（跨字段条件，用户要到 C）**
- 需要支持：
  - “如果选了某类型 → 某字段必填”
  - “字段之间互相约束/格式约束”
  - “填了A → B必须满足格式/范围”
- 校验提示效果：类似现在“电话填错的提示”，用户一眼能看到哪里错、怎么改。

### 1.3 模板/方案（同入口多版本）
- 同一个入口/按钮可以对应多套“表单方案/模板”（例如：发货入口里可能出现“发货/委托”两种场景）。
- 当系统自动选错时：用户通过“改一个选项”即可切换（并立即按新方案刷新字段/必填/按钮等）。

### 1.4 历史单据与回滚（稳定性）
- 模板发布后：**老单据保持原样**（不跟着新模板变化）。
- 必须支持：**一键回滚上一版模板**。

### 1.5 “总表单 + 节点配置”（流程会长出字段）
- 管理员先定义一张“总表单”（包含该类单据所有字段的集合）。
- 再按流程节点配置：该节点哪些字段可见/可填/必填/只读（字段可随时被管理员调整位置与分组）。
- 同一张单据流转到不同节点：节点不同，出现的字段与按钮不同（满足“不同人填不同内容，单据逐步变完整”）。

---

## 1.6 按钮系统（显示条件 + 动作引擎 + 动作组合 + 可填原因）
> 本轮子负责“按钮怎么执行”，并要求所有表单按钮最终走统一口子，避免后期补功能每页都改。

### 1.6.1 按钮本身（可配置）
- 按钮名称允许管理员自定义（显示名可改）。
- 按钮可配置出现/隐藏（基于条件）；必要时可配置“不可点击并提示原因”（是否需要置灰提示：Unknown，后续在权限轮子里统一决定）。

### 1.6.2 按钮出现条件（可配置）
- 条件维度需要支持（已确认）：
  A. 当前节点/状态  
  B. 账号角色/权限（未来会做；当前流程可能暂未接入）  
  C. 单据类型（如申请类型/委托类型等）  
  D. 关键字段是否已填  
  E. 金额/数量阈值  
- 条件组合：支持 AND/OR。
- 护栏：不做“无限嵌套的超复杂条件”（复杂度上限：Unknown，后续冻结）。

### 1.6.3 按钮动作引擎（预置动作库）
> 动作库是“通用积木”，按钮只是选择哪些动作 + 怎么组合。

**建议第一版就内置的常见动作类型（效果口径）**
1) 取消/返回
- 若有未保存改动：提示“确认离开吗”（是否弹出由统一规则决定，默认建议弹）
2) 保存草稿
- 保存当前填写内容，但不推进流程
3) 清空表单
- 清空本次填写（可选：二次确认）
4) 提交/发起
- 通过校验后提交并进入下一节点/状态
5) 通过/同意
- 通过校验后推进到下一节点/状态
6) 驳回
- 要求填写原因/备注（已确认支持），然后退回到指定节点/状态
7) 退回补充
- 要求填写原因/备注（已确认支持），退回到“补充资料”节点/状态
8) 撤回
- 在允许撤回的条件下，把单据拉回到前一节点/发起人（具体规则可配置）
9) 关闭/作废
- 要求填写原因/备注，然后结束单据
10) 转派/指派处理人
- 选择接手人后把单据/待办转给对方（并记录原因：可选）
11) 跳转/打开某页面
- 例如打开详情页/列表页/某个功能页（不涉及具体技术，仅定义为“跳转动作”）
12) 刷新/回到列表（副作用）
- 执行动作后刷新数据、回列表、弹成功提示等（统一由动作引擎处理）

> 说明：动作库后续允许新增，不要求一次想全；新增不视为返工。

### 1.6.4 动作组合（受控组合，已确认）
- 动作引擎支持“受控组合”：
  - 先校验 → 要求填原因/备注 → 状态流转/跳转/副作用
- “原因/备注”能力已确认：驳回/关闭/退回补充等支持填写原因/备注。

### 1.6.5 统一动作口子（关键护栏，决定后加是否麻烦）
- 所有表单的按钮点击最终必须走同一条流程（统一口子）：
  1) 收集当前表单数据
  2)（可选）执行校验（必填/格式/跨字段规则）
  3)（可选）要求填写原因/备注
  4) 执行动作（提交/流转/保存草稿/撤回/关闭/转派等）
  5) 统一处理结果（提示、刷新、回列表、记录日志等）

> 目的：以后给“已完成的表单”补新能力（例如新增一种动作/新增确认门）只需要在统一口子上加，不需要每个表单单独插。

### 1.6.6 与“确认提交/规则提醒门”的关系（仅声明，不在本轮子实现）
- 本轮子负责“按钮动作引擎”与统一口子。
- “提交确认/重复提醒”属于另一个轮子（Confirm/Warning Gate），由它决定是否在第 2) 校验前后插入弹框并展示摘要；本轮子只需预留挂接点。

---

## 1.7 字段停用与字段类型修改（护栏，防止统计混乱）
- 字段停用策略（已确认）：新单据不再显示；老单据仍可看到历史值（只读）。
- 字段类型修改：存在统计/历史混乱风险。建议护栏（默认规则）：
  - 字段一旦产生历史数据，不允许直接改类型；需要“新增新字段 + 旧字段停用”。

---

## 2) 已提供的实物/背景（用于理解目标效果）
- 已提供：平台管理页多个入口按钮与申请弹窗截图（服务申请/销售申请/替企申请/新建机构等）。
- 已提供：工单新建页面截图（字段较典型，适合作为试点）。
- 当前状态：发货表单仅占位；委托入口未做（将来补齐后再接入轮子）。

---

## 3) 未确认（Unknown / 下次继续重点）
> 以下不允许脑补；需要实物或你明确口径。

### 3.1 流程节点清单（每个流程的“节点顺序 + 谁填什么”）
- 工单：节点顺序与各节点责任人/需补字段类别（未完整冻结）。
- 申请：不同入口（服务/销售/替企/新建机构）各自流程节点与责任人（未完整冻结）。
- 发货/委托：流程节点与责任人（未开始）。

### 3.2 “账号角色/权限维度”如何落地到配置（未来必做）
- 你确认“角色完全不同，不应该出现错的表单”；但权限模块尚未完整落地到页面。
- 需要冻结：权限上线后，入口/按钮/字段是“隐藏”还是“置灰提示无权限”（未冻结）。

### 3.3 模板生效方式
- 立即生效 vs 定时生效：默认建议“立即生效”，定时是否必须第一版支持（未冻结）。

### 3.4 条件复杂度护栏（防臃肿）
- 已冻结：支持 AND/OR；不做“无限嵌套的超复杂条件”。
- 仍需冻结：条件编辑器允许到什么复杂度（例如最多几层组合）（未冻结）。

### 3.5 动作库的首批范围是否需要再扩
- 当前列的是建议首批常见动作；是否还需要“导出/打印/生成”等动作（未冻结）。

---

## 4) 下次继续需要的实物（最省沟通版）
1) 四类流程的“节点列表（人话即可）”：
- 每条流程：节点顺序；每个节点是谁在操作；大概填哪些内容（不需要字段名大全）。
2) 发货/委托表单：至少给一个雏形（字段分组/区块也行），或字段清单（字段名+一句话解释）。
3) 权限上线后的体验选择：无权限的入口/按钮要“隐藏”还是“置灰提示”（二选一即可）。

---

## 5) 下次续聊的切入点（避免重复劳动）
- 先用“工单 + 平台申请（服务申请等入口）”作为试点，把轮子的配置能力做稳（字段/布局/校验 + 按钮条件 + 动作引擎统一口子）。
- 再补“发货/委托”表单与流程节点，把同一套轮子接进去。
- 条件维度（角色/阈值/委托类型）先保留扩展槽位：有需求再开，不让第一版变臃肿。
