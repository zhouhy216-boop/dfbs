# DFBS 公司云管系统（单公司主体）- MVP 范围冻结文件（最终整合版 v2）

> **用途**：本文件用于“锁定需求与项目边界”，确保开发过程中不跑偏、不返工。  
> **阅读对象**：业务负责人、产品/研发/测试、实施与运维。  
> **说明**：全文为中文，并配有“为什么要这样做”的注释，便于非技术同学理解。  
> **版本**：v2（包含：报价单模块深度规则 + 仓库两级结构 + 零部件/BOM + 费用&报销&统计）  
> **更新时间**：2026-01-15

---

## 0. 总体边界与基本原则（必须先看）

### 0.1 系统定位与边界
- **单一公司主体**的内部协同系统（多个部门共同使用），**不做多租户**。  
  - 注释：你们是同一家公司内部用，避免为了多租户做一堆复杂隔离，节省成本。
- 外部服务商/物流商以“系统账号 + 权限”方式参与（如物流更新、回执上传），**不做客户门户**。  
  - 注释：客户不直接登录系统，避免需求膨胀。
- 部署策略：现阶段以**节省成本**为主，但架构上保留未来**横向扩展**可能（例如多实例/多节点）。  
  - 注释：现在先单机/单实例，组件独立（DB/MQ/搜索/对象存储）确保以后可以扩容。

### 0.2 删除策略与历史口径（防止“账被改了”）
- **软删除为主**：禁止物理删除。历史口径通过“作废/停用/冲销/更正/退回”等方式处理。  
  - 注释：财务与审计最怕“数据消失”，所以用软删除和冲销口径保留历史。
- 一切关键行为必须可追溯：审计日志 + 版本历史 + 决策留痕 + 时间线视图（详见 1.5）。  

### 0.3 唯一号规则（强约束，必须一次到位）
- 合同号 / 机器号 / ICCID：**全系统全局唯一**。  
- 唯一号进入“正式主数据且被引用”后：
  - ❌ 不允许“把号码改成另一个实体”（俗称“改绑别的实体”）。  
    - 注释：否则历史单据引用会被悄悄改口径，审计会崩。
  - ✅ 允许“关系迁移/转移”（带生效日期、原因、日志）：
    - 机器可换客户（归属变更）
    - ICCID 可在机器间迁移绑定  
  - 注释：**允许迁移 ≠ 允许复用/重复**。迁移是建立新的关联关系记录，并保留历史。

### 0.4 报价是所有对外收费的唯一入口（骨架级结论）
- **物流/客户委托项收费、售后收费、平台费与 ICCID 计费**：全部必须先走**报价单流程**。  
- **没有“生效报价版本”→ 不允许进入收费确认/开票执行**。  
- 报价可以最终不收费（拒绝/过期/作废），但必须进入审计与统计。  
  - 注释：这条是你们最关键的“财务主干”，所有模块都要围绕它实现。

### 0.5 附件策略（你已确认：查看=下载）
- 附件统一存对象存储；下载必须先过系统权限校验，再生成签名 URL（1–24h）。  
- 权限策略：**能查看对象详情/附件列表 ⇒ 就能下载附件**（不做“下载单独权限”）。  
- 下载行为也要记录审计（谁、何时、下载了哪个附件）。  
  - 注释：即使“查看=下载”，也要留下载日志，便于追溯。

### 0.6 货损模块的独立性（重要：防止模块边界跑偏）
- **货损记录（damage）与售后维修/收费完全独立**。  
  - 注释：货损只做“记录、查询、附件、审计、统计”，不强行和报价/收费打通；避免后期逻辑纠缠。
- 货损模块共享底座能力：权限、附件、审计、搜索、导入导出（如需要），但业务闭环独立。

### 0.7 收入 vs 成本（运费/垫付）口径（v2 新增冻结规则）
> 注释：你们真实业务里“客户付给公司”与“服务经理先垫付”同时存在。必须把“收入”和“费用报销”分开，否则账会乱。
- **是否进入报价**决定“对客户怎么收费”（收入口径）。  
- **谁先垫付**决定“内部是否需要报销”（成本口径）。  
- 允许同一物流事件：  
  - 报价里有“对客户收的运费”（QuoteItem，收入）  
  - 同时存在“服务经理垫付的快递费”（Expense，成本/报销）  
- 但必须满足：
  - ✅ 收入与费用分别记录、分别统计  
  - ✅ 通过同一出库/物流/快递记录关联  
  - ❌ 禁止用一条记录同时充当收入与费用（防止口径混乱）

---

## 1. 平台底座（V1 必做，否则后期必返工）

> 注释：底座是“所有业务模块共用的能力”。如果底座缺失，后期每个模块都会重复造轮子，且返工成本极高。

### 1.1 配置中心（Config Center）
- 配置版本化：草稿版本 → 发布版本；可回滚。
- 灰度发布：按账号/账号标签白名单；支持优先级/冲突处理。
- 配置依赖分析：删除/停用前提示被哪些规则/报表/导入导出模板/状态机引用。
- 发布前静态检查：权限/规则/状态机冲突、死路、全放开/全拒绝风险。  
  - 注释：防止配置“发布即事故”。

### 1.2 规则引擎（Rule Engine）
- 统一表达式语言：支持 user.xxx 与 record.xxx、AND/OR、in/contains/is null 等。
- 覆盖范围：
  - 记录可见范围（数据范围）
  - 动作权限（按钮能不能点）
  - 字段级可见/可编辑
  - 状态流转权限
  - 待办/SLA规则
  - 校验规则条件（如“若某字段=xxx，则必填/不可填”）
- 规则测试器：可模拟用户+记录，输出命中路径与解释。
- **决策留痕**：每次关键判定生成“决策记录”（用于排障与审计）。  

### 1.3 多维度状态机（Workflow）
- 状态“维度”可配置：同一单据可并行多个状态维度（财务/物流/维修/报价/开票…）。
- 每个维度支持：状态、流转、会签/多层审批、必填、字段锁定集合、动作按钮。
- 支持跨维度条件：某动作要求多个维度满足条件。
- 与审批联动：审批通过自动推进对应维度状态。
- **退回上个环节（你确认需要）**：
  - 仅允许退回相邻状态（防止乱跳）
  - 必填退回原因
  - 退回行为进入审计与时间线
  - 退回后待办自动重算/重生成  

### 1.4 权限模型（两层）
- 基础勾选层：由超级管理员勾选“模块/动作/字段”的基础资格（不依赖组织架构）。
- 规则层：在满足条件下可见/可改/可流转（表达式规则）。
- 导出/下载严格遵守权限裁剪：导出字段与记录范围必须裁剪，不能绕开页面权限。  

### 1.5 版本化与审计（可检索/可导出）
- 关键表版本化：主表存当前版本 + history 表存历史版本（快照对比即可）。
- 审计日志类型：
  - 业务操作日志：新增/修改/状态变化/附件变化
  - 管理操作日志：配置发布/回滚、灰度调整、批量接管等
  - 决策记录：规则/校验/公式/流转的解释与输入输出
  - 下载审计：附件下载记录
- 权限变更：仅超管可操作；**必须记录变更历史（操作者/时间/变更内容）**。  
  - 注释：你们不要求“强追责永久审计”也可以，但不能不留历史。

### 1.6 异步底座与任务中心（你已确认必须要“任务监控面板”）
- 消息队列：统一异步底座（索引同步、通知、导入处理、反写迁移、Webhook投递、报表预计算…）。
- 任务中心（可视化运维面板）必须支持：
  - 任务状态：成功/失败/重试中/死信
  - 手工重试/终止/重放
  - 幂等键统一规范（防重复执行）
  - 指数退避重试（你已采纳：1s 起，最大 30s，最多 5 次）
  - 死信队列（DLQ）与人工/自动处理策略
- 监控告警：任务延迟/失败率/Webhook失败/汇率拉取失败等；站内通知为基础，保留邮件/短信扩展。

### 1.7 Webhook 与外部集成（预留但底座要先铺）
- Webhook：至少一次投递；事件ID幂等；订阅可配置；事件可追踪与重放。
- 外部系统集成：API鉴权、速率限制、数据同步等机制预留。

### 1.8 搜索（一步到位）
- 上搜索引擎（ES/OpenSearch）。
- 异步同步索引；可全量重建。
- 自定义字段：标记为可搜索/筛选/排序/报表的字段需自动生成影子结构（DB侧）并同步到搜索引擎。
- 默认搜索/报表只针对“当前版本”；历史版本仅详情追溯。  

### 1.9 附件
- 对象存储；下载走系统权限校验后签名 URL（1–24h）。
- 附件版本化；旧版本允许手工清理但必须留清理日志。  

### 1.10 备份恢复与沙箱
- 备份：数据库 + 附件；每周全量 + 每日增量（建议）；保留策略：重要数据 1 年，普通 3–6 个月。
- 支持按时间点恢复（PITR 思路）；索引可重建。
- 支持按粒度恢复（单表/单附件）以降低影响面。
- 沙箱：从正式按时间范围抽取数据（如近3个月）用于配置/迁移演练。  

### 1.11 多币种与汇率（你已确认）
- 每笔金额保存：原币金额 + 币种 + 当时汇率 + 折算人民币金额。
- 汇率自动拉取；未确认/草稿随汇率更新自动重算并落库；确认后锁定。
- 不存汇率历史（只要在单据上锁定当时汇率即可）。  

---

## 2. 业务模块（V1 必须跑通的闭环）

> 注释：V1 不是“全功能”，而是验证底座能支撑所有模块共性需求（权限/状态/规则/审计/附件/搜索/导入导出/任务/通知待办）。

### 2.1 主数据（客户/合同/机型/机器/ICCID）
- 客户：
  - 支持别名映射到同一客户（避免重复客户）。
  - 支持导入占位：若客户不存在，先入临时表，由管理员确认后转正式。
- 合同：合同号全局唯一；客户可多合同。
- 机型：独立机型表（涉及运费/售后等配置）。
- 机器：归属可变；变更需生效日期与历史可查。
- ICCID：卡实体唯一；可迁移绑定；变更需生效日期与历史可查。

### 2.2 发货（Shipment）
- 发货记录、签收信息、回执附件。
- 关键字段支持导入；物流状态维度可配置（例如“待发/在途/签收/异常”）。

### 2.3 客户委托（Entrust）/物流委托收费来源
- 记录客户委托信息，可关联发货、费用、报价。
- 委托相关收费：必须先走报价（见 2.7 报价）。

### 2.4 货损记录（Damage）【V1 必须存在】
- 货损记录台账：时间、关联对象（可选：发货/机器/合同）、描述、照片/附件、责任归属（可选）、处理结果（可选）。
- **明确独立性**：不与售后维修/收费、平台费/ICCID 自动联动（避免业务耦合）。
- 共享底座：附件、审计、搜索、导入导出（如需要）。

### 2.5 售后维修台账（Repair Ledger）
- 先做“完修记录台账”；后续对接工单系统写入。
- 故障知识库与高级检索属于后续迭代，但搜索底座需一次到位。

### 2.6 零部件主数据与 BOM（v2 新增：V1 必做）
> 注释：这是仓库/报价/未来工单的共同基础。零部件不能只做成“机型字段”，必须独立建表。
- 零部件（Part）：
  - 编码/名称/规格/单位/参考价等
  - 参考价不强约束，但要能**标记偏离**（用于风控/审批可见）
- 机型零部件清单（BOM）：
  - 一个机型对应多个零部件
  - 可选记录“推荐数量/备注”
- 未来预留：
  - 保内/保外零部件消耗都扣库存（与工单系统联动）

### 2.7 报价单（Quote）——收费枢纽模块（v2 深化规则）
#### 2.7.1 角色流转（你描述的真实流程）
- 报价单发起者：创建草稿 → 提交服务经理  
- 服务经理：与客户确认 → 修改草稿 → 提交财务  
- 财务：审核确认 → 定稿（形成生效版本）  
- 仓库：根据报价明细出库、上传快递单（涉及配件时）  
- 服务经理：收款后填回款信息，可发起发票申请  
- 财务：确认回款，并推进开票/入账处理

#### 2.7.2 报价来源（可混合合并）
- 可关联并合并多来源：
  - 物流/客户委托收费
  - 售后收费
  - 平台费/ICCID 账期收费
- **支持人工报价**：允许无来源直接发起（客户单买配件、问价等）。
- 人工报价允许后补来源（必须留审计，通常以“新版本”方式体现）。

#### 2.7.3 明细粒度（费用项 + 来源追溯）
- 一张报价单允许“配件类明细 + 服务类明细”混合（你已确认）。  
- 每行明细必须能追溯来源（来源类型 + 来源ID，可为空表示人工）。

#### 2.7.4 版本（你已确认：旧版本保留，仅一个生效）
- 一张报价支持多版本（V1/V2…）；任一时刻仅 1 个版本 Active（生效）。
- **执行锁定**：收费/开票在创建/确认时绑定某个生效报价版本；关键节点后永久锁定，不受后续新版本影响。
- 新版本生效时：旧版本标记失效（保留可追溯）。

#### 2.7.5 反复报价与推荐合并
- 同一来源允许反复报价；同一时间只允许一个“有效报价链路”（避免并发多个有效报价造成执行口径混乱）。
- 系统推荐合并（同客户、时间范围、来源相近），由人工确认合并。

#### 2.7.6 “无需报价”受控放行（你已确认）
- 系统提醒“未进入任何生效报价的可报价项”。
- 若业务选择“无需报价”：必须填写原因并进入审核流程（留审计与统计）。  
  - 注释：这是防漏收/防随意放弃收入的“管理控制”。

#### 2.7.7 退回机制（你已确认）
- 下个环节可以“退回上个环节”（相邻状态），必填原因，留审计，待办重算。

#### 2.7.8 报价与仓库联动（v2 新增冻结）
- **可见性**：仓库从报价草稿阶段即可看到报价（可见≠可执行），并能看到报价状态。  
  - 注释：为了应对“加急发货、确认来不及”的现实场景。
- **不预占库存**：报价阶段只校验提示，不冻结数量（你已确认 A）。
- **出库绑定**：每次出库必须逐条绑定到报价明细（你已确认 A）。
- **分批出库**：报价明细允许分多次出库（你已确认 A）。
- **出库不阻塞回款**：未出库/部分出库也允许进入回款填写与财务确认（你已确认 B），系统仅提示“存在未出库明细”。
- **服务经理可视化出库状态**：服务经理在报价详情查看每条明细出库数量/状态汇总（你已确认需要）。
- **加急异常出库（例外）**：允许未定稿前预出库，但必须异常标记+原因+审计，后续补齐定稿或冲销。

### 2.8 仓库管理（Inventory，标准型，v2 新增：V1 必做）
> 注释：你们是“服务部大库 + 服务经理小库”的真实结构。V1 做轻量但够用的库存体系，不做 ERP。
- 两级仓库：
  - 服务部仓库（大库）：给服务经理补货/发货
  - 服务经理仓库（小库）：日常常用件备库
- 库存联动：
  - 报价选配件时校验小库库存；不足时提示“申请服务部发货/备库申请”
  - 未来工单消耗同样扣库存（预留）
- 备库申请：
  - 服务经理向服务部发起备库/发货申请
  - 支持人工提醒 + 系统库存告警触发提醒
- 库存告警：
  - 常用件设置安全库存阈值
  - 低于阈值提醒服务经理发起申请
- 出库与物流：
  - 出库必须绑定报价明细，允许分批
  - 上传快递单/物流附件
- V1 明确不做（防止膨胀）：
  - 批次/批号、库龄
  - 成本核算（加权平均等）
  - 自动补货/复杂调拨

### 2.9 收费执行（After-sales Fee / Platform Fee / ICCID Fee）——执行报价结果
- 通用原则：**无生效报价版本不得确认收费/开票**。
- 分次回款：系统必须支持多次回款记录（你已确认）。
- 金额一致性原则（你确认的处理方式）：
  - 若需要“多收/金额变化”：不能在收费端直接超收；必须申请修改报价（退回/新版本）使金额一致后再继续执行。
- 少收/不收：必须结案原因（客户减免/坏账/内部让利等），差额进入统计与审计。
- 已确认记录：关键字段锁定（金额、回款、开票相关）；展示类字段可随主数据纠错反写。

### 2.10 开票（Invoice）——独立并行环节（以回款完成为准）
- 报价确认后才能进入收费与开票环节。
- 回款作为“完成”口径；发票可能后补，因此：
  - 允许先票后款、先款后票、以及“不需要发票（后续可补）”
  - 报价单的“发票申请”仅作为申请入口保留，不作为完成条件
- 入账口径（你确认）：
  - **开票即入账**；冲红/红字为冲减事件（可追溯）。

### 2.11 费用 & 报销 & 简单统计（Expense/Claim，v2 新增：V1 必做）
> 注释：这是“公司成本”主干，和报价（收入）分离，但可以通过客户/工单/物流/出库关联做利润分析。
- 费用事实（Expense）：
  - 记录：谁、因为什么（出差/工单/客户/仓库发货）、多少钱、时间、附件
  - 支持分类：运费/住宿/交通/餐饮/其他
- 报销申请（Claim）：
  - 从费用事实中勾选
  - 提交审批
  - 通过/驳回/退回
  - 审计与时间线
- 简单统计维度（你已确认 B）：
  - 按出差/工单/客户/人员维度统计
  - 支持时间范围筛选、导出
- V2 预留（不在 V1 实现，但表结构/状态要留口）：
  - 财务入账凭证号、入账状态
  - 对公/对私支付标记
  - 与外部财务系统对接

### 2.12 出差申请（定位建议：V1 作为审批表单类型，不做大模块）
> 注释：你提出“工单不在常驻地需要出差”。V1 建议先做成“审批底座的一个表单类型”，避免做成完整 OA。
- 出差申请：出差城市、时间范围、事由、预计费用、附件
- 审批配置：由超管配置（多层审批/会签可用）
- 可关联：工单（未来）、客户（可选）
- 与费用/报销联动：出差结束后产生费用事实，再走报销

### 2.13 通知与待办
- 站内通知：已读/未读、筛选、搜索、阅读审计、对象跳转。
- 待办中心：规则驱动生成/关闭；SLA 升级；代理与紧急越权批量接管。
- 高优先级通知：站内 + 邮件/短信可扩展；要求回执确认。

### 2.14 导入导出（你已确认）
- 多方式导入（Excel/CSV/API）；导入后批量校验并反馈错误。
- 导入任务：唯一ID、进度、日志可导出；完成后生成导入报告（站内通知）。
- 导出模板可配置；严格遵守字段级权限与数据范围。
- 自定义字段：支持固定预定义字段 + 动态映射；可搜索字段需同步索引。

### 2.15 报表（Reporting）
- 策略：核心指标预计算 + 临时筛选实时算。
- 双口径：
  - 回款口径（现金流）
  - 开票口径（入账/税务），支持冲红冲减
- 成本口径（来自费用）：可按客户/工单/人员/时间统计
- 利润分析（V2 可做，V1 先留关联键）：收入（报价）- 成本（费用）按事件关联。

---

## 3. 明确不做（V1 不做但预留）
- 客户门户（客户直接登录）
- 离线模式
- 复杂 ERP：库存成本核算、批次库龄、自动补货等
- 财务入账/对公支付闭环（V2）
- 完整工单系统（V2）

---

## 4. V1 验收口径（建议）
- 任一模块都能做到：配置驱动字段/状态/权限；审计与版本；附件；搜索；导入导出；通知待办；任务可观测；回滚可用
- 报价模块闭环验收：
  - 多来源混合合并报价、人工报价可独立发起
  - 多版本仅一个生效，收费/开票执行锁定版本
  - 无报价不能收费/开票
  - “无需报价”必须原因+审核
  - 退回相邻状态可用且留审计
  - 仓库联动：草稿可见、不预占、明细级出库、分批、出库不阻塞回款、服务经理可见出库状态
- 仓库模块验收：
  - 两级仓库结构可用
  - 备库申请可发起、可跟踪、可审计
  - 库存告警可触发提醒
  - 出库与物流附件可追溯
- 费用/报销验收：
  - 费用事实可记录、可上传附件
  - 报销审批可配置、可追溯
  - 统计按出差/工单/客户/人员维度可查可导
- 任务中心验收：
  - 导入任务/索引同步/Webhook/预计算任务均可观察、可重试、可死信处理，并可告警

---

# 附录A：v2.1_final 本窗口“第二轮反查 + 最后一次反查”冻结补充条款（必须执行）

> 说明：本附录是对 v2 的**冻结级补充**，用于彻底消除歧义，避免开发/测试/业务理解不一致导致返工。
> 本附录与正文同等权威；如有冲突，以本附录为准（因为它来自本窗口的最终确认）。

## A0. 本附录覆盖范围（本窗口已确认且必须落地）
- 平台底座（必须现在补）：ObjectRef、ObjectLink、RelationHistory（生效区间）、BizTime、OrgUnit（业务归属）、统一编号（内部号+外部号映射）、MoneySpec+Period、FinancialEvent、冲正/调整、导入强人工确认、全面软删除、多维度状态机、附件必传规则（配置驱动）、可见性口径（RBAC为准）。
- 本窗口新增/明确业务模块：对账单、回款核销分配、费用分摊、PriceBook/RatePlan、承运商与运费口径、委托/订单主线、RMA、非维修工单、更正单、经办人事实统计、（留口：库存流转、检测结论、客户应收视图、附件规则逐步启用）。

---

## A1. 价格建议（Price Suggestion）与人工确认（最终口径）

### A1.1 核心原则
- 系统对价格/费率/最低执行结果只提供“建议”，**最终以人工确认结果为准**。
- 系统必须支持“与合同规则集合不一致”的提示能力（用于提醒，不强制阻断）。

### A1.2 委托/订单与合同关系（价格来源）
- 委托/订单（Order/委托）**不强绑定单一合同**，只绑定客户（customer）。
- 价格建议来源：该客户的“合同规则集合”（例如：同客户多合同按最低执行）。
- 关键点：系统要能展示“建议价如何得出”（例如命中的合同/规则摘要），但最终以人工确认为准。

### A1.3 价格建议的计算时点与停止规则（极重要）
- **仅在报价单处于“编辑阶段”（未递交）时**，系统允许根据合同规则集合给出“价格建议”。
- 报价单在向下一个流程递交时，必须点击明确按钮（例如：`递交到下一环节`）。
- **一旦发生第一次递交：即视为价格已确认，并触发“永久停止自动建议”**：
  - 以后无论合同/规则/时间如何变化；
  - 无论报价单是否被驳回/打回/撤回再编辑；
  - 系统都不得对该报价单再次自动计算/刷新建议价。
- 递交后的价格变化：**只能人工显式修改**，必须填写修改原因，并记录审计日志。

### A1.4 价格变更与财务不可变（与冲正/调整的衔接）
- 若报价递交后仅修改“报价价格”，属于业务变更，必须记录原因与审计。
- 若变更已影响并形成了已确认的财务结果（已对账/已确认计费/已开票等），则不得直接改历史财务记录，必须通过**冲正/调整（Reversal/Adjustment）**机制完成修正（详见 A4）。

---

## A2. 回款（Payment）核销/分摊与跨周期规则（最终口径）

### A2.1 回款与核销关系
- 一笔回款允许分摊到：
  - 多张对账单（Statement / Reconciliation）
  - 多张发票（Invoice）
  - 多个订单/委托（Order）
- 支持部分核销与剩余挂账（未分配金额）。

### A2.2 跨周期分配
- **允许跨周期（Period）分配**：
  - 回款本身有“发生时间（BizTime）”与自身归属信息；
  - 回款分配明细可以指向不同周期的 Statement/Invoice/Order。
- 报表口径（必须统一）：
  - “应收/已收/未收”等周期汇总，以**分配明细归属的 Period**为准；
  - 同时保留回款事件的发生期用于审计与追溯（不要覆盖/丢失）。

### A2.3 数据结构要求（落库口径）
- Payment（回款主记录 / FinancialEvent: PAYMENT）+ PaymentAllocation（回款分配明细）必须存在：
  - PaymentAllocation 至少包含：`payment_event_id`、`target_object_ref`、`allocated_amount`、`period_id`、`allocated_at`、`allocated_by`。
  - 未分配余额需要可计算/可查询（用于挂账与后续分配）。

---

## A3. 附件类型与关键附件必传规则（可配置口径）

### A3.1 附件统一挂载
- 所有附件一律通过 ObjectRef（`object_type + object_id`）挂载，附件本身带 `attachment_type`（类型枚举/白名单）。

### A3.2 关键附件必传规则：基于“业务类型 + 状态”配置
- 关键附件校验规则以配置驱动，不写死在流程节点中：
  - 规则形式：`object_type + status -> required_attachment_type[]`
- 工作流/状态机负责推进状态；附件服务负责按规则校验是否满足：
  - 可配置为“仅提示”或“强制阻断”（后续逐步启用）。
- 规则变更需审计：谁改的、改了什么、何时改。

---

## A4. 多维度状态机（并行状态维度）

- 同一业务对象允许多个并行状态维度同时存在，例如（按对象启用）：
  - `biz_status`（履约/业务）
  - `approval_status`（审批）
  - `finance_status`（财务）
  - `logistics_status`（物流）
  - `repair_status`（维修）
- 各维度：
  - 独立流转、独立审计、独立规则触发；
  - 允许互相产生规则联动，但**不得合并为一个“巨型单状态”**。

---

## A5. 主数据合并/去重（Merge）策略（最终口径）

- **仅客户（Customer）允许合并**：
  - 合并后必须保留被舍弃客户为“别名 alias”（用于搜索/历史引用/外部名称）。
  - 合并行为必须审计：操作者、时间、原因、主从客户ID。
- 其他主数据（合同/机器/ICCID/机型等）**禁止合并**：
  - 允许更正字段、停用/作废，但不得做“实体合并迁移”。

---

## A6. 导入占位与管理员确认（强人工确认）

- 临时表仅用于占位与校验提示，不得自动创建高风险主数据。
- 业务数据入正式表前，管理员必须逐条确认/映射引用主数据。
- 导入任务必须有清晰状态机（示例）：
  - `UPLOADED -> VALIDATED -> PENDING_REVIEW -> APPROVED/REJECTED -> IMPORTED`
- 每一步需审计：谁操作、操作结果、失败原因、回滚/重试记录。

---

## A7. 删除策略（全面软删除）

- 主数据/业务单据/财务事件一律禁止物理删除：
  - 采用 `is_deleted`/`status=VOID/ARCHIVED` 等方式作废/归档；
  - 财务修正仅允许冲正/调整，不允许删除或覆盖。
- 附件文件的物理清理由“归档/保留策略”控制，但附件记录与审计记录不可删。

---

## A8. 搜索/报表的数据可见性口径

- **默认按 RBAC 权限决定可见性**（你们的现实跨部门协作模式）。
- OrgUnit/CostCenter 不做强可见性过滤，仅用于报表/统计筛选与汇总。
- 对少量敏感数据（例如财务）使用更细粒度权限点控制（例如“查看全部财务事件/仅看本人/仅看指定范围”等）。

---

## A9. 业务时间（BizTime）与系统时间（SystemTime）强制区分

- 所有关键业务事件必须同时记录：
  - `biz_time/occurred_at`（业务实际发生时间）
  - `system_time/created_at`（系统录入时间）
- 报表/计费/追溯的默认口径，以 `biz_time` 为准；必要时可切换查看 `system_time`（用于审计与数据质量排查）。

---

# 附录B：本窗口新增/确认模块清单（仅列“做/留口”结论，便于对照）

## B1. 本窗口确认“V1 做”
- 对账单/对账批次（Statement/Reconciliation）
- 回款记录（Payment/Receipt）与核销分摊（含跨周期）
- 费用分摊/拆分（Allocation/Split）
- 价格/费率表（PriceBook/RatePlan），含“同客户多合同按最低执行”规则
- 工单/服务请求（非维修）
- 数据更正单（Correction）
- 承运商/快递商管理 + 运费口径（客户承担/公司成本）
- 委托/订单（履约主线对象）
- RMA（退货/返修/换货）
- 经办人事实统计页（非绩效考核）

## B2. 本窗口确认“先留口”
- 客户应收/回款状态视图（仅定义口径与数据源，UI后做）
- 库存/出入库/调拨（先定数据结构与状态，UI后做）
- 检测/质检结论（先用维修备注承载，后续可拆）
- 附件类型与关键节点必传规则：先定义类型与校验点，逐步启用（配置驱动）

